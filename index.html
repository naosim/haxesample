<!DOCTYPE html>
<meta charset="utf-8"/>
<body></body>
<script src="js/main.js"></script>
<script src="js/enchant.js-builds-0.8.2-b/build/enchant.js"></script>
<script>
    var imagePath = function(name){ return "js/enchant.js-builds-0.8.2-b/images/" + name + ".png"; };
    var addImage = function(name) { image[name] = imagePath(name); };
    var image = {};
    addImage("chara1");
    addImage("icon0");

    enchant(); // initialize
    var game = new Core(320, 320); // game stage
    game.preload(image.chara1, image.icon0); // preload image
    game.fps = 30;

    // スペースキーをaボタンにバインド
    game.keybind(' '.charCodeAt(0), 'a');

    var player = null;

    Sprite.prototype.setCenter = function(pos) {
        this.x = pos.x - this.width/2;
        this.y = pos.y - this.height/2;
    }

    var createPlayer = function(c) {
        var bear = new Sprite(32, 32);
        bear.playerCollision = c;
        bear.image = game.assets[image.chara1];
        bear.addEventListener('enterframe', function () {
            bear.setCenter(c.pos);

            if (game.input.up) c.up();
            if (game.input.down) c.down();
            if (game.input.right) c.right();
            if (game.input.left) c.left();
        });
        c.registerHitPoint(function(before, after) {
            console.log(before, after);
        });
        return bear;
    }

    var createShot = function(c) {
        var result = new Sprite(16, 16);
        result.frame = 48;
        result.playerCollision = c;
        result.image = game.assets[image.icon0];
        result.setCenter(c.pos);
        result.addEventListener('enterframe', function () {
            result.setCenter(c.pos);
        });
        return result;
    }

    var createEnemy = function(c) {
        var result = new Sprite(16, 16);
        result.frame = 16;
        result.playerCollision = c;
        result.image = game.assets[image.icon0];
        result.setCenter(c.pos);
        result.addEventListener('enterframe', function () {
            result.setCenter(c.pos);
        });
        return result;
    }

    game.onload = function () {
        Main.setup(
        {width:320, height:320},
        function(c){
            var sprite;
            if(c.hasTag("player")) {
                sprite = player = createPlayer(c);
            } else if(c.hasTag("shot")) {
                sprite = createShot(c);
            } else if(c.hasTag("enemy")) {
                sprite = createEnemy(c);
            }

            if(sprite) {
                c.sprite = sprite;
                game.rootScene.addChild(sprite);
            }

        },
        function(c){
            game.rootScene.removeChild(c.sprite);
            console.log("delete");
        });

        game.addEventListener('abuttondown', function () {
            // 「a」ボタンを押した時のイベント処理
            console.log("a");
            player.playerCollision.shot();
        });

        game.rootScene.addEventListener('enterframe', function () {
            Main.gameCore.step();
        });
    };

    game.start(); // start your game!
</script>
